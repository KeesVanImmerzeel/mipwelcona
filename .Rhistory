conc_strm_lns
tail(conc_strm_lns)
.mw_conc_streamlines(
conc_strm_lns=conc_strm_lns,
times = c(0, 1 * 365, 5 * 365, 10 * 365, 25 * 365),
processes = c("dispersion","decay", "retardation"),
alpha = 0.3,
rho = 3,
labda = 0.0001,
retard=1
)
load_all()
.mw_conc_streamlines(
conc_strm_lns=conc_strm_lns,
times = c(0, 1 * 365, 5 * 365, 10 * 365, 25 * 365),
processes = c("dispersion","decay", "retardation"),
alpha = 0.3,
rho = 3,
labda = 0.0001,
retard=1
)
?dplyr::group_by
fname <- system.file("extdata","streamlines.iff",package="mipwelcona")
strm_lns <- mw_read_streamlines(fname)
conc_l_lev <- mw_example_conc_layer_levels()
conc_l_lev <- mw_example_conc_layer_levels()
x <- mw_init(strm_lns, conc_l_lev, conc_l)
x
load_all()
x <- mw_init(strm_lns, conc_l_lev, conc_l)
x
fname <-
system.file("extdata", "streamlines.iff", package = "mipwelcona")
chk_mw_read_streamlines <- mw_read_streamlines(fname)
fname <-
system.file("extdata", "well_filters.ipf", package = "mipwelcona")
chk_mw_read_well_filters <- mw_read_well_filters(fname)
chk_sl_fltr_table <- .mw_create_sl_fltr_table(chk_mw_read_streamlines, chk_mw_read_well_filters)
# Read example concentration layer levels (8 rasters layers).
conc_l_lev <- mw_example_conc_layer_levels()
# Read example initial concentrations of different layers in the subsoil (9 raster layers).
conc_l <- mw_example_concentrations()
#Initialize base streamline concentration table.
chk_mw_init <- mw_init(chk_mw_read_streamlines, conc_l_lev, conc_l)
chk_mw_conc_streamlines <-
.mw_conc_streamlines(
conc_strm_lns=chk_mw_init,
times = c(0, 1 * 365, 5 * 365, 10 * 365, 25 * 365),
processes = c("dispersion","decay", "retardation"),
alpha = 0.3,
rho = 3,
labda = 0.0001
)
usethis::use_data(chk_mw_read_streamlines,
chk_mw_read_well_filters,
chk_sl_fltr_table,
chk_mw_init,
chk_mw_conc_streamlines,
overwrite = TRUE,
internal = TRUE)
load_all()
rm(list = c("chk_mw_conc_streamlines", "chk_mw_init", "chk_mw_read_streamlines", "chk_mw_read_well_filters", "chk_sl_fltr_table"))
load_all()
# Read streamlines.`
fname <- system.file("extdata","streamlines.iff",package="mipwelcona")
strm_lns <- mw_read_streamlines(fname)
# Read well filters.`
fname <- system.file("extdata","well_filters.ipf",package="mipwelcona")
well_fltrs <- mw_read_well_filters(fname)
# Read example initial concentrations of different layers in the subsoil (9 raster layers).
conc_l <- mw_example_concentrations()
# Read example concentration layer levels (8 rasters layers).
conc_l_lev <- mw_example_conc_layer_levels()
#Initialize base streamline concentration table.
conc_strm_lns <- mw_init(strm_lns, conc_l_lev, conc_l)
x <-
.mw_conc_streamlines(
conc_strm_lns=conc_strm_lns,
times = c(0, 1 * 365, 5 * 365, 10 * 365, 25 * 365),
processes = c("dispersion","decay", "retardation"),
alpha = 0.3,
rho = 3,
labda = 0.0001,
retard=1
)
fname <-
system.file("extdata", "streamlines.iff", package = "mipwelcona")
chk_mw_read_streamlines <- mw_read_streamlines(fname)
fname <-
system.file("extdata", "well_filters.ipf", package = "mipwelcona")
chk_mw_read_well_filters <- mw_read_well_filters(fname)
chk_sl_fltr_table <- .mw_create_sl_fltr_table(chk_mw_read_streamlines, chk_mw_read_well_filters)
# Read example concentration layer levels (8 rasters layers).
conc_l_lev <- mw_example_conc_layer_levels()
# Read example initial concentrations of different layers in the subsoil (9 raster layers).
conc_l <- mw_example_concentrations()
#Initialize base streamline concentration table.
chk_mw_init <- mw_init(chk_mw_read_streamlines, conc_l_lev, conc_l)
chk_mw_conc_streamlines <-
.mw_conc_streamlines(
conc_strm_lns=chk_mw_init,
times = c(0, 1 * 365, 5 * 365, 10 * 365, 25 * 365),
processes = c("dispersion","decay", "retardation"),
alpha = 0.3,
rho = 3,
labda = 0.0001
)
chk_mw_conc_streamlines
chk_mw_init
str(chk_mw_init)
conc_strm_lns <- mw_init(strm_lns, conc_l_lev, conc_l)
conc_strm_lns
x <- .mw_conc_streamlines(conc_strm_lns, times=c(1*365,5*365,10*365,25*365), processes=c("dispersion","decay", "retardation"), alpha=0.3, rho=3, labda=0.0001, retard=1)
x
load_all()
library(devtools)
load_all()
## ONLY RE-CREATE CHECK OBJECT IF THE EXISTING OBJECT IS NOT CORECT (ANYMORE).
fname <-
system.file("extdata", "streamlines.iff", package = "mipwelcona")
chk_mw_read_streamlines <- mw_read_streamlines(fname)
fname <-
system.file("extdata", "well_filters.ipf", package = "mipwelcona")
chk_mw_read_well_filters <- mw_read_well_filters(fname)
chk_sl_fltr_table <- .mw_create_sl_fltr_table(chk_mw_read_streamlines, chk_mw_read_well_filters)
# Read example concentration layer levels (8 rasters layers).
conc_l_lev <- mw_example_conc_layer_levels()
# Read example initial concentrations of different layers in the subsoil (9 raster layers).
conc_l <- mw_example_concentrations()
#Initialize base streamline concentration table.
chk_mw_init <- mw_init(chk_mw_read_streamlines, conc_l_lev, conc_l)
chk_mw_init
chk_mw_conc_streamlines <-
.mw_conc_streamlines(
conc_strm_lns=chk_mw_init,
times = c(0, 1 * 365, 5 * 365, 10 * 365, 25 * 365),
processes = c("dispersion","decay", "retardation"),
alpha = 0.3,
rho = 3,
labda = 0.0001
)
chk_mw_conc_streamlines
chk_mw_init
conc_strm_lns <- chk_mw_init
conc_strm_lns
times <- c(0, 1 * 365, 5 * 365, 10 * 365, 25 * 365)
processes <- c("dispersion","decay", "retardation")
alpha <- 0.3
rho <- 3
labda <- 0.0001
retard=1
x <-
.mw_conc_streamlines(
conc_strm_lns=conc_strm_lns,
times = c(0, 1 * 365, 5 * 365, 10 * 365, 25 * 365),
processes = c("dispersion","decay", "retardation"),
alpha = 0.3,
rho = 3,
labda = 0.0001,
retard=1
)
x
conc_strm_lns %>% dplyr::group_map(
~ .f(
.x,
SL_NR = .y$SL_NR,
times = times,
processes = processes,
alpha = alpha,
rho = rho,
labda = labda,
retard = retard
)
)
###################### Local function definitions ##################################################################
# Function to calculate the cumulative probability or nonexceedance probability of the Pearson Type III
# distribution.
# @param x A real value vector and a vector of parameter values for the distribution specified by type.
#       so x[1]=x; x[2:4]=c(mu, sigma, gamma)
# @return Nonexceedance probability (F) for x.
.p3 <- function(x) {
#print(x)
vec <- c(x[2:4])
x <- x[1]
# Convert a Vector of Parameters to a Parameter Object of a Distribution
p <- lmomco::vec2par(vec, 'pe3')
# cumulative probability or nonexceedance probability of the Pearson Type III distribution given parameters (μ, σ, and γ)
return(lmomco::cdfpe3(x, para = p))
}
# Calculate fraction of each change in concentration on streamline "data" at t using Pearson III (cumulative).
.calc_f <- function(t, data) {
cbind(t, data$TIME, data$sigma, data$gamma) %>% as.matrix() %>% apply(MARGIN = 1, .p3)
}
# Calculate the sum of the product of all fractions (ref. "calc_f") with the changes in concentrations
# on streamline "data". Add to initial concentration (conc0).
.disp_conc <- function(f, data, conc0) {
conc0 + sum(f[2:length(f)] * data$D_CCONC)
}
# Function to add PearsonIII parameters sigma en gamma to conc_strm_lns table (as variables).
# in case the process of dispersion is included.
.addPearsonParameters <-
function(conc_strm_lns,
alpha = 0.3,
rho = 3) {
conc_strm_lns %<>%
dplyr::mutate(b = TIME / rho) %>%
dplyr::mutate(a = DIST * (1 - 1 / rho) / (TIME * 2 * alpha)) %>%
dplyr::mutate(n = DIST * ((1 - 1 / rho) ^ 2) / (2 * alpha)) %>%
dplyr::mutate(sigma = sqrt(n) / a) %>%
dplyr::mutate(gamma = 2 / sqrt(n)) %>%
dplyr::select(-c(a, n))
return(conc_strm_lns)
}
# Calculate the concentrations on streamline "data" (a tibble, ref. \code{\link{mw_init}) at "times" (numeric vector).
#
# @inheritParams mw_conc_streamlines
# @return data frame with the following variables (columns):
# * SL_NR: Streamline number (integer)
# * TIME: Time, days (numeric)
# * CONC: Concentration (numeric)
.f <- function(data,
SL_NR,
times,
processes = c("retardation"),
alpha = 0.3,
rho = 3,
labda = 0.0001,
retard = 1) {
print(SL_NR)
print(data)
if ("retardation" %in% processes) {
data$TIME <- data$TIME / retard
alpha <- alpha / retard
}
if ("dispersion" %in% processes) {
conc <- rep(data$CCONC[1], length(times)) # Concentration at t=0
if (nrow(data) >= 2) {
# More then 2 concentrations in table
flt_data <- data %>% dplyr::filter(TIME > 0)
f <-
purrrlyr::by_row(times %>% as.data.frame(),
.calc_f,
data = flt_data,
.collate = "cols")
conc <-
purrrlyr::by_row(
f %>% as.data.frame(),
.disp_conc,
data = flt_data,
conc = conc[1],
# Concentration at t=0
.collate = "cols"
)
conc <-
conc[, ncol(conc)] %>% as.data.frame() %>% dplyr::rename(CONC = .out)
}
} else {
# Conservative
conc <- stats::approx(
data$TIME,
y = data$CCONC,
xout = times,
method = "constant",
rule = c(2:2)
)$y
}
if ("decay" %in% processes) {
conc <- conc * exp(-labda * times)
}
df <- data.frame(
SL_NR = SL_NR,
TIME = times,
CONC = conc
)
return(df)
}
####################################################################################################################
x <- conc_strm_lns %>% dplyr::group_map(
~ .f(
.x,
SL_NR = .y$SL_NR,
times = times,
processes = processes,
alpha = alpha,
rho = rho,
labda = labda,
retard = retard
)
)
conc_strm_lns
dplyr::group_map(
~ .f(
.x,
SL_NR = .y$SL_NR,
times = times,
processes = processes,
alpha = alpha,
rho = rho,
labda = labda,
retard = retard
)
)
###################### Local function definitions ##################################################################
# Function to calculate the cumulative probability or nonexceedance probability of the Pearson Type III
# distribution.
# @param x A real value vector and a vector of parameter values for the distribution specified by type.
#       so x[1]=x; x[2:4]=c(mu, sigma, gamma)
# @return Nonexceedance probability (F) for x.
.p3 <- function(x) {
#print(x)
vec <- c(x[2:4])
x <- x[1]
# Convert a Vector of Parameters to a Parameter Object of a Distribution
p <- lmomco::vec2par(vec, 'pe3')
# cumulative probability or nonexceedance probability of the Pearson Type III distribution given parameters (μ, σ, and γ)
return(lmomco::cdfpe3(x, para = p))
}
# Calculate fraction of each change in concentration on streamline "data" at t using Pearson III (cumulative).
.calc_f <- function(t, data) {
cbind(t, data$TIME, data$sigma, data$gamma) %>% as.matrix() %>% apply(MARGIN = 1, .p3)
}
# Calculate the sum of the product of all fractions (ref. "calc_f") with the changes in concentrations
# on streamline "data". Add to initial concentration (conc0).
.disp_conc <- function(f, data, conc0) {
conc0 + sum(f[2:length(f)] * data$D_CCONC)
}
# Function to add PearsonIII parameters sigma en gamma to conc_strm_lns table (as variables).
# in case the process of dispersion is included.
.addPearsonParameters <-
function(conc_strm_lns,
alpha = 0.3,
rho = 3) {
conc_strm_lns %<>%
dplyr::mutate(b = TIME / rho) %>%
dplyr::mutate(a = DIST * (1 - 1 / rho) / (TIME * 2 * alpha)) %>%
dplyr::mutate(n = DIST * ((1 - 1 / rho) ^ 2) / (2 * alpha)) %>%
dplyr::mutate(sigma = sqrt(n) / a) %>%
dplyr::mutate(gamma = 2 / sqrt(n)) %>%
dplyr::select(-c(a, n))
return(conc_strm_lns)
}
# Calculate the concentrations on streamline "data" (a tibble, ref. \code{\link{mw_init}) at "times" (numeric vector).
#
# @inheritParams mw_conc_streamlines
# @return data frame with the following variables (columns):
# * SL_NR: Streamline number (integer)
# * TIME: Time, days (numeric)
# * CONC: Concentration (numeric)
.f <- function(data,
SL_NR,
times,
processes = c("retardation"),
alpha = 0.3,
rho = 3,
labda = 0.0001,
retard = 1) {
print(SL_NR)
print(data)
if ("retardation" %in% processes) {
data$TIME <- data$TIME / retard
alpha <- alpha / retard
}
if ("dispersion" %in% processes) {
conc <- rep(data$CCONC[1], length(times)) # Concentration at t=0
if (nrow(data) >= 2) {
# More then 2 concentrations in table
flt_data <- data %>% dplyr::filter(TIME > 0)
f <-
purrrlyr::by_row(times %>% as.data.frame(),
.calc_f,
data = flt_data,
.collate = "cols")
conc <-
purrrlyr::by_row(
f %>% as.data.frame(),
.disp_conc,
data = flt_data,
conc = conc[1],
# Concentration at t=0
.collate = "cols"
)
conc <-
conc[, ncol(conc)] %>% as.data.frame() %>% dplyr::rename(CONC = .out)
}
} else {
# Conservative
conc <- stats::approx(
data$TIME,
y = data$CCONC,
xout = times,
method = "constant",
rule = c(2:2)
)$y
}
if ("decay" %in% processes) {
conc <- conc * exp(-labda * times)
}
df <- data.frame(
SL_NR = SL_NR,
TIME = times,
CONC = conc
)
return(df)
}
####################################################################################################################
x <- conc_strm_lns %>% dplyr::group_map(
~ .f(
.x,
SL_NR = .y$SL_NR,
times = times,
processes = processes,
alpha = alpha,
rho = rho,
labda = labda,
retard = retard
)
) %>% dplyr::bind_rows(x)
conc_strm_lns %>% dplyr::group_map(
~ .f(
.x,
SL_NR = .y$SL_NR,
times = times,
processes = processes,
alpha = alpha,
rho = rho,
labda = labda,
retard = retard
)
)
.f
fname <- system.file("extdata","streamlines.iff",package="mipwelcona")
strm_lns <- mw_read_streamlines(fname)
conc_l <- mw_example_concentrations()
conc_l_lev <- mw_example_conc_layer_levels()
conc_strm_lns <- mw_init(strm_lns, conc_l_lev, conc_l)
conc_strm_lns
.mw_conc_streamlines(conc_strm_lns, times=c(1*365,5*365,10*365,25*365), processes=c("dispersion","decay", "retardation"), alpha=0.3, rho=3, labda=0.0001, retard=1)
load_all()
library(devtools)
load_all()
fname <- system.file("extdata","streamlines.iff",package="mipwelcona")
strm_lns <- mw_read_streamlines(fname)
conc_l <- mw_example_concentrations()
conc_l_lev <- mw_example_conc_layer_levels()
conc_strm_lns <- mw_init(strm_lns, conc_l_lev, conc_l)
x <- .mw_conc_streamlines(conc_strm_lns, times=c(1*365,5*365,10*365,25*365), processes=c("dispersion","decay", "retardation"), alpha=0.3, rho=3, labda=0.0001, retard=1)
x
load_all()
## ONLY RE-CREATE CHECK OBJECT IF THE EXISTING OBJECT IS NOT CORECT (ANYMORE).
fname <-
system.file("extdata", "streamlines.iff", package = "mipwelcona")
chk_mw_read_streamlines <- mw_read_streamlines(fname)
fname <-
system.file("extdata", "well_filters.ipf", package = "mipwelcona")
chk_mw_read_well_filters <- mw_read_well_filters(fname)
chk_sl_fltr_table <- .mw_create_sl_fltr_table(chk_mw_read_streamlines, chk_mw_read_well_filters)
# Read example concentration layer levels (8 rasters layers).
conc_l_lev <- mw_example_conc_layer_levels()
# Read example initial concentrations of different layers in the subsoil (9 raster layers).
conc_l <- mw_example_concentrations()
#Initialize base streamline concentration table.
chk_mw_init <- mw_init(chk_mw_read_streamlines, conc_l_lev, conc_l)
# Calculate concentrations on streamlines at specified times.
chk_mw_conc_streamlines <-
.mw_conc_streamlines(
conc_strm_lns=chk_mw_init,
times = c(0, 1 * 365, 5 * 365, 10 * 365, 25 * 365),
processes = c("dispersion","decay", "retardation"),
alpha = 0.3,
rho = 3,
labda = 0.0001
)
chk_mw_conc_streamlines
load_all()
library(devtools)
load_all()
fname <-
system.file("extdata", "streamlines.iff", package = "mipwelcona")
chk_mw_read_streamlines <- mw_read_streamlines(fname)
fname <-
system.file("extdata", "well_filters.ipf", package = "mipwelcona")
chk_mw_read_well_filters <- mw_read_well_filters(fname)
chk_sl_fltr_table <- .mw_create_sl_fltr_table(chk_mw_read_streamlines, chk_mw_read_well_filters)
# Read example concentration layer levels (8 rasters layers).
conc_l_lev <- mw_example_conc_layer_levels()
# Read example initial concentrations of different layers in the subsoil (9 raster layers).
conc_l <- mw_example_concentrations()
#Initialize base streamline concentration table.
chk_mw_init <- mw_init(chk_mw_read_streamlines, conc_l_lev, conc_l)
# Calculate concentrations on streamlines at specified times.
chk_mw_conc_streamlines <-
.mw_conc_streamlines(
conc_strm_lns=chk_mw_init,
times = c(0, 1 * 365, 5 * 365, 10 * 365, 25 * 365),
processes = c("dispersion","decay", "retardation"),
alpha = 0.3,
rho = 3,
labda = 0.0001
)
chk_mw_read_streamlines
chk_mw_read_well_filters
chk_sl_fltr_table
chk_mw_init
chk_mw_conc_streamlines
usethis::use_data(chk_mw_read_streamlines,
chk_mw_read_well_filters,
chk_sl_fltr_table,
chk_mw_init,
chk_mw_conc_streamlines,
overwrite = TRUE,
internal = TRUE)
document()
